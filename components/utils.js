// Countries list
export const countries = [
  { name: "Afghanistan", code: "af", flag: "af.png" },
  { name: "Algeria", code: "dz", flag: "dz.png" },
  { name: "Angola", code: "ao", flag: "ao.png" },
  { name: "Argentina", code: "ar", flag: "ar.png" },
  { name: "Australia", code: "au", flag: "au.png" },
  { name: "Austria", code: "at", flag: "at.png" },
  { name: "Bangladesh", code: "bd", flag: "bd.png" },
  { name: "Belarus", code: "by", flag: "by.png" },
  { name: "Belgium", code: "be", flag: "be.png" },
  { name: "Belize", code: "bz", flag: "bz.png" },
  { name: "Bolivia", code: "bo", flag: "bo.png" },
  { name: "Bosnia and Herzegovina", code: "ba", flag: "ba.png" },
  { name: "Botswana", code: "bw", flag: "bw.png" },
  { name: "Brazil", code: "br", flag: "br.png" },
  { name: "Bulgaria", code: "bg", flag: "bg.png" },
  { name: "Cambodia", code: "kh", flag: "kh.png" },
  { name: "Cameroon", code: "cm", flag: "cm.png" },
  { name: "Canada", code: "ca", flag: "ca.png" },
  { name: "Chile", code: "cl", flag: "cl.png" },
  { name: "China", code: "cn", flag: "cn.png" },
  { name: "Colombia", code: "co", flag: "co.png" },
  { name: "Congo, D.R.", code: "cd", flag: "cd.png" },
  { name: "Costa Rica", code: "cr", flag: "cr.png" },
  { name: "Croatia", code: "hr", flag: "hr.png" },
  { name: "Cyprus", code: "cy", flag: "cy.png" },
  { name: "Czech Republic", code: "cz", flag: "cz.png" },
  { name: "CÃ´te d'Ivoire", code: "ci", flag: "ci.png" },
  { name: "Denmark", code: "dk", flag: "dk.png" },
  { name: "Dominican R.", code: "do", flag: "do.png" },
  { name: "Ecuador", code: "ec", flag: "ec.png" },
  { name: "Egypt", code: "eg", flag: "eg.png" },
  { name: "El Salvador", code: "sv", flag: "sv.png" },
  { name: "Estonia", code: "ee", flag: "ee.png" },
  { name: "Finland", code: "fi", flag: "fi.png" },
  { name: "France", code: "fr", flag: "fr.png" },
  { name: "Gabon", code: "ga", flag: "ga.png" },
  { name: "Georgia", code: "ge", flag: "ge.png" },
  { name: "Germany", code: "de", flag: "de.png" },
  { name: "Greece", code: "gr", flag: "gr.png" },
  { name: "Guatemala", code: "gt", flag: "gt.png" },
  { name: "Honduras", code: "hn", flag: "hn.png" },
  { name: "Hong Kong", code: "hk", flag: "hk.png" },
  { name: "Hungary", code: "hu", flag: "hu.png" },
  { name: "Iceland", code: "is", flag: "is.png" },
  { name: "India", code: "in", flag: "in.png" },
  { name: "Indonesia", code: "id", flag: "id.png" },
  { name: "Iran, Islamic Republic of", code: "ir", flag: "ir.png" },
  { name: "Iraq", code: "iq", flag: "iq.png" },
  { name: "Ireland", code: "ie", flag: "ie.png" },
  { name: "Israel", code: "il", flag: "il.png" },
  { name: "Italy", code: "it", flag: "it.png" },
  { name: "Japan", code: "jp", flag: "jp.png" },
  { name: "Jordan", code: "jo", flag: "jo.png" },
  { name: "Kazakhstan", code: "kz", flag: "kz.png" },
  { name: "Kenya", code: "ke", flag: "ke.png" },
  { name: "Korea, Republic of", code: "kr", flag: "kr.png" },
  { name: "Kosovo", code: "xk", flag: "xk.png" },
  { name: "Kuwait", code: "kw", flag: "kw.png" },
  { name: "Lao People's D.R.", code: "la", flag: "la.png" },
  { name: "Latvia", code: "lv", flag: "lv.png" },
  { name: "Lebanon", code: "lb", flag: "lb.png" },
  { name: "Libya", code: "ly", flag: "ly.png" },
  { name: "Lithuania", code: "lt", flag: "lt.png" },
  { name: "Luxembourg", code: "lu", flag: "lu.png" },
  { name: "Macao", code: "mo", flag: "mo.png" },
  { name: "Malawi", code: "mw", flag: "mw.png" },
  { name: "Malaysia", code: "my", flag: "my.png" },
  { name: "Maldives", code: "mv", flag: "mv.png" },
  { name: "Mexico", code: "mx", flag: "mx.png" },
  { name: "Montenegro", code: "me", flag: "me.png" },
  { name: "Morocco", code: "ma", flag: "ma.png" },
  { name: "Myanmar", code: "mm", flag: "mm.png" },
  { name: "Nauru", code: "nr", flag: "nr.png" },
  { name: "Netherlands", code: "nl", flag: "nl.png" },
  { name: "New Zealand", code: "nz", flag: "nz.png" },
  { name: "Nicaragua", code: "ni", flag: "ni.png" },
  { name: "Nigeria", code: "ng", flag: "ng.png" },
  { name: "Norway", code: "no", flag: "no.png" },
  { name: "Oman", code: "om", flag: "om.png" },
  { name: "Pakistan", code: "pk", flag: "pk.png" },
  { name: "Panama", code: "pa", flag: "pa.png" },
  { name: "Paraguay", code: "py", flag: "py.png" },
  { name: "Peru", code: "pe", flag: "pe.png" },
  { name: "Philippines", code: "ph", flag: "ph.png" },
  { name: "Poland", code: "pl", flag: "pl.png" },
  { name: "Portugal", code: "pt", flag: "pt.png" },
  { name: "Qatar", code: "qa", flag: "qa.png" },
  { name: "Romania", code: "ro", flag: "ro.png" },
  { name: "Russian Federation", code: "ru", flag: "ru.png" },
  { name: "Rwanda", code: "rw", flag: "rw.png" },
  { name: "Saudi Arabia", code: "sa", flag: "sa.png" },
  { name: "Senegal", code: "sn", flag: "sn.png" },
  { name: "Serbia", code: "rs", flag: "rs.png" },
  { name: "Singapore", code: "sg", flag: "sg.png" },
  { name: "Slovakia", code: "sk", flag: "sk.png" },
  { name: "Slovenia", code: "si", flag: "si.png" },
  { name: "South Africa", code: "za", flag: "za.png" },
  { name: "Spain", code: "es", flag: "es.png" },
  { name: "Sri Lanka", code: "lk", flag: "lk.png" },
  { name: "Sudan", code: "sd", flag: "sd.png" },
  { name: "Sweden", code: "se", flag: "se.png" },
  { name: "Switzerland", code: "ch", flag: "ch.png" },
  { name: "Syrian Arab Republic", code: "sy", flag: "sy.png" },
  { name: "Taiwan", code: "tw", flag: "tw.png" },
  { name: "Tanzania, United Republic of", code: "tz", flag: "tz.png" },
  { name: "Thailand", code: "th", flag: "th.png" },
  { name: "Togo", code: "tg", flag: "tg.png" },
  { name: "Trinidad and Tobago", code: "tt", flag: "tt.png" },
  { name: "Tunisia", code: "tn", flag: "tn.png" },
  { name: "Turkey", code: "tr", flag: "tr.png" },
  { name: "Uganda", code: "ug", flag: "ug.png" },
  { name: "Ukraine", code: "ua", flag: "ua.png" },
  { name: "United Arab Emirates", code: "ae", flag: "ae.png" },
  { name: "United Kingdom", code: "gb", flag: "gb.png" },
  { name: "United States", code: "us", flag: "us.png" },
  { name: "Uruguay", code: "uy", flag: "uy.png" },
  { name: "Uzbekistan", code: "uz", flag: "uz.png" },
  { name: "Venezuela", code: "ve", flag: "ve.png" },
  { name: "Vietnam", code: "vn", flag: "vn.png" },
  { name: "Yemen", code: "ye", flag: "ye.png" },
  { name: "Zambia", code: "zm", flag: "zm.png" },
  { name: "Zimbabwe", code: "zw", flag: "zw.png" },
]
export const stopwords = [
  "a",
  "b",
  "c",
  "d",
  "e",
  "f",
  "g",
  "i",
  "h",
  "j",
  "k",
  "l",
  "m",
  "n",
  "o",
  "p",
  "q",
  "r",
  "s",
  "t",
  "u",
  "v",
  "w",
  "x",
  "y",
  "z",
  "me",
  "my",
  "myself",
  "we",
  "our",
  "ours",
  "ourselves",
  "you",
  "your",
  "yours",
  "yourself",
  "yourselves",
  "he",
  "him",
  "his",
  "himself",
  "she",
  "her",
  "hers",
  "herself",
  "it",
  "its",
  "itself",
  "they",
  "them",
  "their",
  "theirs",
  "themselves",
  "what",
  "which",
  "who",
  "whom",
  "this",
  "that",
  "these",
  "those",
  "am",
  "is",
  "are",
  "was",
  "were",
  "be",
  "been",
  "being",
  "have",
  "has",
  "had",
  "having",
  "do",
  "does",
  "did",
  "doing",
  "an",
  "the",
  "and",
  "but",
  "because",
  "until",
  "while",
  "for",
  "with",
  "about",
  "against",
  "between",
  "into",
  "through",
  "during",
  "before",
  "after",
  "above",
  "below",
  "from",
  "down",
  "out",
  "off",
  "over",
  "under",
  "again",
  "further",
  "then",
  "once",
  "here",
  "there",
  "when",
  "where",
  "why",
  "how",
  "all",
  "any",
  "both",
  "each",
  "few",
  "more",
  "most",
  "other",
  "some",
  "such",
  "nor",
  "not",
  "only",
  "own",
  "same",
  "so",
  "than",
  "too",
  "very",
  "can",
  "will",
  "just",
  "don",
  "should",
  "now",
  "use",
  "it's",
]
// funcion for getting recent apps data
export function getRecentAppData() {
  const recentSelectedApp = JSON.parse(
    localStorage.getItem("Recent Selected App"),
  )
  const recentSuggestion = recentSelectedApp?.map(item => {
    let deviceIcon
    if (item.device === "apple")
      deviceIcon =
        "https://uploads-ssl.webflow.com/63806eb7687817f7f9be26de/6492f645042f50918e6e390f_app-store.svg"
    else
      deviceIcon =
        "https://uploads-ssl.webflow.com/63806eb7687817f7f9be26de/6492f644817f822625b18bb6_google-play-store.svg"
    item.deviceIcon = deviceIcon
    return item
  })
  const uniqueRecentAppsArray = uniqueArray(recentSuggestion, "app-package-id")
  return uniqueRecentAppsArray
}

function uniqueArray(arr, key) {
  const seen = new Set()
  return arr?.filter(item => {
    const keyValue = item[key]
    if (seen.has(keyValue)) {
      return false
    } else {
      seen.add(keyValue)
      return true
    }
  })
}

// data fetching
function encodingName(e) {
  return encodeURIComponent(e)
}
export async function prepareDataForRequests(
  searchKeyword,
  selectedCountryCode,
) {
  let currentNameIOS = searchKeyword
  let currentNamePlay = encodingName(searchKeyword)
  let country = selectedCountryCode
  if (currentNameIOS.trim().length < 2 && currentNameIOS.trim() === "") {
    return false
  }
  const newKeyword = currentNameIOS.split(" ").join("+")
  const requestIOS = `https://itunes.apple.com/search?media=software&entity=software%2CiPadSoftware%2CsoftwareDeveloper&term=${newKeyword}&country=${country}&limit=30`
  if (
    requestIOS.trim() ===
    `https://itunes.apple.com/search?media=software&entity=software%2CiPadSoftware%2CsoftwareDeveloper&term=&country=&limit=30`
  ) {
    return false
  }
  let requestPlay = `https://store.maakeetoo.com/apps/search/?q=${currentNamePlay}&gl=${country}`
  if (
    requestPlay.trim() ===
    `https://store.maakeetoo.com/apps/search/?q=&gl=${country}`
  ) {
    return false
  }
  let listData = await handleRequestsAndProcessData(requestPlay, requestIOS)
  return listData
}

async function handleRequestsAndProcessData(requestPlay, requestIOS) {
  try {
    const response1 = await fetch(requestIOS)
    const response2 = await fetch(requestPlay)
    const iOSResponse = await response1.json()
    const playResponse = await response2.json()

    const mergedData = {
      iOSResponse: iOSResponse,
      playResponse: playResponse,
    }

    const fullAppData = mergedExtractedData(mergedData)
    const suggestionList = createListWithDevice(fullAppData)

    return suggestionList
  } catch (error) {
    console.error("Error:", error)
    return false
  }
}

// merging fetched data
function mergedExtractedData(rowData) {
  let appDataMain = []
  let appDataA = []
  let appDataP = []
  rowData.iOSResponse.results.map(item => {
    if (item.trackViewUrl) {
      let iosData = {
        dataPackageUrl: item.trackViewUrl,
        appPackageId: item.trackViewUrl.split("/")[5],
        app_icon: item.artworkUrl100,
        appName: item.trackName,
        developer: "By " + item.artistName,
        device: "apple",
        deviceIcon: "apple_icon.svg",
      }
      appDataA.push(iosData)
    }
  })
  rowData.playResponse.map(item => {
    let playData = {
      dataPackageUrl:
        "https://play.google.com/store/apps/details?id=" + item.package_id,
      appPackageId: item.package_id,
      app_icon: item.app_icon,
      appName: item.title,
      developer: "By " + item.developer_name,
      device: "android",
      deviceIcon: "android_icon.svg",
    }
    appDataP.push(playData)
  })
  appDataA.map((app, index) => {
    appDataMain.push(appDataA[index])
    if (appDataP[index]) {
      appDataMain.push(appDataP[index])
    }
  })
  if (appDataA.length === 0) appDataMain = appDataP
  return appDataMain
}

//app list with device icon and type
function createListWithDevice(data) {
  const formattedData = data.map(item => {
    if (item.appName !== undefined) {
      let deviceIcon
      if (item.device == "apple")
        deviceIcon =
          "https://uploads-ssl.webflow.com/63806eb7687817f7f9be26de/6492f645042f50918e6e390f_app-store.svg"
      else
        deviceIcon =
          "https://uploads-ssl.webflow.com/63806eb7687817f7f9be26de/6492f644817f822625b18bb6_google-play-store.svg"
      item.deviceIcon = deviceIcon
      return item
    }
  })
  return formattedData
}

// generating seo data 
const removeStopwords = str => {
  let res = []
  let words = str.split(" ")
  for (let word of words) {
    let wordClean = word.split(".").join("")
    if (!stopwords.includes(wordClean)) {
      res.push(wordClean)
    }
  }
  return res.join(" ")
}

export const generateKeywordTable = description => {
  let keyword = description.toLowerCase().replace(/[,.():<>?;/:!*\n]+/g, " ")
  keyword = removeStopwords(keyword)
  const filteredKeyword = keyword.split(" ").filter(item => item.length > 2)

  const countFreq = arr => {
    const keywordTable = []
    const visited = Array(arr.length).fill(false)

    for (let i = 0; i < arr.length; i++) {
      if (visited[i]) continue
      let count = 1
      for (let j = i + 1; j < arr.length; j++) {
        if (arr[i] === arr[j]) {
          visited[j] = true
          count++
        }
      }
      keywordTable.push({ keyword: arr[i], count })
    }
    return keywordTable
  }

  const keywordWithCount = countFreq(filteredKeyword)
  let finalKeywordTable = keywordWithCount
    .sort((a, b) => b.count - a.count)
    .slice(0, 10)

  return finalKeywordTable
}


// fetch and render app data
export async function fetchAndStoreAppDataToBox(
  appPackageURL,
  applicationId,
  device,
  country
) {
  
  if (device == "apple") {
    let result = await fetchAppleAppData(appPackageURL, country);
    const appData = JSON.stringify({ apple: result });
    localStorage.setItem("selectedAppData", appData);
    return result;
  } else {
    let result = await fetchPlayStoreAppData(applicationId, country);
    const appData = JSON.stringify({ android: result });
    localStorage.setItem("selectedAppData", appData);
    return result;
  }
}



// fetch app data
async function fetchPlayStoreAppData(applicationId, t) {
  const url = `https://store.maakeetoo.com/apps/details/?id=${applicationId}&gl=${t}`;
  try {
    const response = await fetch(url);
    const data = await response.json();
    // return data;
    if (data.url) {
      let dataObject = {};
      dataObject.packageURL = data.url;
      dataObject.packageId = data.appId;
      dataObject.appIcon = data.icon;
      dataObject.appName = data.title;
      dataObject.appPrice = data.priceText;
      dataObject.userRating = (data.score).toFixed(2);
      dataObject.genresName = data.genre;
      dataObject.appFileSize = (parseInt(data.size) / (1000 * 1000)).toFixed(2);
      let date = new Date(data.updated);
      dataObject.lastUpdateDate = date.toDateString();
      dataObject.lastUpdateNotes = data.recentChanges;
      dataObject.appScreenshot = data.screenshots;
      dataObject.screenshotCount = data.screenshots.length;
      dataObject.appDescription = data.description;
      dataObject.appReleaseDate = data.released || "2021-01-01";
      let copyright = 'Â© ' + new Date(dataObject.appReleaseDate).getFullYear() + " " + data.developer;
      dataObject.appCopyright = copyright;
      dataObject.type = "play";
      return dataObject;
  } else {
      window.alert("Warning! Please select the app from the dropdown menu.");
  }
  } catch (error) {
    throw new Error(`Error fetching Play Store app data: ${error}`);
  }
}

async function fetchAppleAppData(appPackageURL, t) {
  const requestOptions = {
    method: "GET",
    redirect: "follow",
  };
  const regex = /\/id(\d+)/;
  const id = appPackageURL.match(regex)[1];
  const requestURL = `https://itunes.apple.com/lookup?id=${id}&country=${t}`;
  try {
    const response = await fetch(requestURL, requestOptions);
    const data = await response.json();
    const row_data = data["results"][0];
    let AppURL = row_data.trackViewUrl;
    if (AppURL) {
        let dataObject = {};
        dataObject.packageURL = row_data.trackViewUrl;
        dataObject.packageId = row_data.trackId;
        dataObject.appIcon = row_data.artworkUrl100;
        dataObject.appName = row_data.trackCensoredName;
        dataObject.appPrice = row_data.formattedPrice;
        dataObject.userRating = (row_data.averageUserRating).toFixed(2);
        dataObject.genresName = (row_data.genres).join(', ');
        dataObject.appFileSize = (parseInt(row_data.fileSizeBytes) / (1000 * 1000)).toFixed(2);
        dataObject.lastUpdateDate = row_data.currentVersionReleaseDate.split('T')[0];
        dataObject.lastUpdateNotes = row_data.releaseNotes;
        dataObject.appScreenshot = row_data.screenshotUrls;
        dataObject.screenshotCount = row_data.screenshotUrls.length;
        dataObject.appDescription = row_data.description;
        dataObject.appReleaseDate = row_data.releaseDate;
        let copyright = 'Â© ' + new Date(row_data.releaseDate).getFullYear() + " " + row_data.sellerName;
        dataObject.appCopyright = copyright;
        dataObject.type = "ios";
        return dataObject;
    } else {
        window.alert("Warning! Please select the app from the dropdown menu.");
    }
  } catch (error) {
    throw new Error(`Error fetching Apple app data: ${error}`);
  }
}
